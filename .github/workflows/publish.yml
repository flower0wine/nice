name: "Create Release"
on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    environment: Release
    steps:
      - uses: actions/checkout@v3

      # è®¾ç½® Node.js å’Œ pnpm
      - uses: actions/setup-node@v3.4.1
        with:
          node-version: 20.16.0

      - name: Install pnpm
        run: npm install -g pnpm@8.15.2

      # å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: pnpm i

      # æ„å»ºå’Œæ‰“åŒ…
      - name: Build the extension
        run: pnpm build

      - name: Package the extension
        run: pnpm package

      # ä» Secrets è·å–å¹¶ä¿å­˜ç§é’¥
      - name: Setup private key
        run: |
          if [ "${{ secrets.EXTENSION_PEM }}" == "" ]; then
            echo "é”™è¯¯ï¼šè¯·å…ˆåœ¨ GitHub Secrets ä¸­è®¾ç½® EXTENSION_PEM"
            exit 1
          fi
          echo "${{ secrets.EXTENSION_PEM }}" > key.pem

      # å®‰è£… Chrome
      - name: Install Chrome
        run: |
          wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt install ./google-chrome-stable_current_amd64.deb

      # æ‰“åŒ… CRX
      - name: Package CRX
        run: |
          google-chrome --pack-extension=build/chrome-mv3-prod --pack-extension-key=key.pem
          mv build/chrome-mv3-prod.crx ./build/nice-${{ github.ref_name }}.crx

      # æ£€æŸ¥æ‰“åŒ…æ–‡ä»¶æ˜¯å¦å­˜åœ¨
      - name: Check package files
        run: |
          if [ ! -f "./build/chrome-mv3-prod.zip" ]; then
            echo "Error: ZIP file not found at ./build/chrome-mv3-prod.zip"
            exit 1
          fi
          if [ ! -f "./build/nice-${{ github.ref_name }}.crx" ]; then
            echo "Error: CRX file not found"
            exit 1
          fi
          echo "Package files exist and ready for upload"
          mv ./build/chrome-mv3-prod.zip ./build/nice-${{ github.ref_name }}.zip

      # åˆ›å»º Release
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          body: |
            # æ–°ç‰ˆæœ¬ Nice ${{ github.ref_name }} å‘å¸ƒğŸ‰âœ¨

            ### æ–°ç‰ˆæœ¬ Nice ${{ github.ref_name }} å‘å¸ƒğŸ‰âœ¨ï¼Œç‚¹å‡»ä¸‹é¢çš„ `nice-${{ github.ref_name }}.zip` è¿›è¡Œä¸‹è½½ï¼Œå¦‚æœä½ æ˜¯å°ç™½ï¼Œè¯·ä¸è¦ä¸‹è½½ source-code.zip æ–‡ä»¶ï¼Œè¿™æ˜¯æ’ä»¶æºä»£ç ã€‚

            ### Q: ä¸ºä»€ä¹ˆä¸å‘å¸ƒåˆ°æ’ä»¶å•†åº—ï¼Ÿ
            A: æœ¬æ¥æˆ‘ä¹Ÿæ˜¯æƒ³å‘çš„ï¼Œä½†æ˜¯ `Edge` å’Œ `Chrome` æ³¨å†Œå¼€å‘è€…éƒ½è¦æ”¶è´¹ï¼ŒEdge æ³¨å†Œè´¹ä¸º **114 å…ƒ**ï¼ŒChrome æ³¨å†Œè´¹ä¸º **5 ç¾å…ƒ**ï¼Œæœ¬èº«è¿™ä¸ªæ’ä»¶å°±æ˜¯**å…è´¹**çš„ï¼Œæ‰€ä»¥å°±æ²¡æ³¨å†Œï¼Œæ‰€ä»¥åªèƒ½æ‰‹åŠ¨ä¸‹è½½å®‰è£…ã€‚

            å¦‚æœä½ æƒ³è®©è¿™ä¸ªæ’ä»¶å‘å¸ƒåœ¨æ’ä»¶å•†åº—ä¸­ï¼Œä½ å¯ä»¥èµåŠ©æˆ‘éƒ¨åˆ†èµ„é‡‘ï¼Œè¿™ä¼šåŠ å¿«å®ƒå‡ºç°åœ¨å•†åº—ä¸­çš„è¿›åº¦ã€‚

            <div align="center">
              <img src="https://github.com/flower0wine/nice/blob/master/docs/images/wechat.jpg" width="40%" alt="å¾®ä¿¡æ”¶æ¬¾ç ">
              <img src="https://github.com/flower0wine/nice/blob/master/docs/images/aipay.jpg" width="40%" alt="æ”¯ä»˜å®æ”¶æ¬¾ç ">
            </div>
          draft: false
          prerelease: false
          files: |
            ./build/nice-${{ github.ref_name }}.zip
